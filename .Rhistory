}
if (df$duration[j] > 15 & df$duration[j] <= 20) {
df$duration_class[j] <- "16-20"
}
if (df$duration[j] > 20 & df$duration[j] <= 30) {
df$duration_class[j] <- "21-30"
}
if (df$duration[j] > 30 & df$duration[j] <= 40) {
df$duration_class[j] <- "31-40"
}
if (df$duration[j] > 40 & df$duration[j] <= 50) {
df$duration_class[j] <- "41-50"
}
if (df$duration[j] > 50 & df$duration[j] <= 60) {
df$duration_class[j] <- "51-60"
}
}
dfd <- df %>%
group_by(duration_class) %>%
summarise(n = length(`Survey name`))
dfd <- data.frame(dfd %>% arrange(duration_class))
dfd$duration_class <- as.character(dfd$duration_class)
if (tot_survey > nrow(df)) {
nas <- tot_survey - nrow(df)
rows <- nrow(dfd) + 1
dfd[rows, ] <- NA
dfd$duration_class[rows] <- "NA"
dfd$n[rows] <- nas
}
dfd$duration_class <- as.factor(dfd$duration_class)
theme_set(theme_bw())
ggplot(dfd, aes(x = duration_class, y = n)) +
geom_bar(stat = "identity", color = "#1e90ff", fill = "#1e90ff") +
xlab("Time series length (years)") +
ylab("Number of surveys") +
geom_text(aes(label = n), vjust = 1.0, colour = "white",size=5) +
labs(fill = "Number\nof surveys") +
theme(legend.position = "none")+
theme(text = element_text(size = 20))
ggsave(file.path(resdir,'Time_series_length.jpg'),height=5,width=8, units='in', dpi=300)
df <- d[, which(colnames(d) %in% c("ICES Eco-Region", "Survey name", "start/end of the survey (\"ongoing\" if not ended)")) ]
colnames(df) <- c("Eco-region", "Survey name", "years" )
dx <- data.frame(matrix(ncol = 3, nrow = 0))
colnames(dx) <- c("Eco-region", "Survey name", "years")
i <- 6
for (i in 1:nrow(df)) {
t <- as.character(df[i, "Eco-region"])
t <- strsplit(t, ", ")
t <- t[[1]]
n <- 1
for (n in 1:length(t)) {
l <- nrow(dx) + 1
dx[l, "Eco-region"] <- t[n]
dx[l, "Survey name"] <- df[i, "Survey name"]
dx[l, "years"] <- df[i, "years"]
}
}
df <- dx
ll <- nrow(df[is.na(df$`Survey name`), ] )
ddd <- which(is.na(df$`Survey name`) )
if (ll >0 ){
for (i in 1:ll) {
df[ddd[i], "Survey name"] <- paste("Survey", i)
}
}
tot_survey <- length(unique(df$`Survey name`) )
df <- df[!is.na(df$years) & df$years != "NA", ]
df <- df[!df$years %in% c("variable ongoing", "variable"), ]
df$years <- sub(" ", "-", df$years)
yy <- strsplit(df$years, "-")
for (i in 1:length(yy)) {
yy[[i]] <- yy[[i]][1:2]
yy[[i]][1] <- as.numeric(yy[[i]][1])
yy[[i]][2] <- suppressWarnings(as.numeric(yy[[i]][2]))
if (is.na(yy[[i]][2])) {
yy[[i]][2] <- 2023
}
}
yy <- do.call(rbind, yy)
yy <- data.frame(yy)
colnames(yy) <- c("start", "end")
df$start <- as.numeric(yy$start)
df$end <- as.numeric(yy$end)
df <- df %>%
group_by(`Eco-region`, `Survey name`) %>%
summarise(start = min(start), end = max(end))
colnames(df) <- c("Eco-Region","Survey name", "start", "end")
df$duration <- (df$end - df$start) + 1
for (j in 1:nrow(df)) {
if (df$duration[j] > 0 & df$duration[j] <= 10) {
df$duration_class[j] <- "1-10"
}
if (df$duration[j] > 10 & df$duration[j] <= 15) {
df$duration_class[j] <- "11-15"
}
if (df$duration[j] > 15 & df$duration[j] <= 20) {
df$duration_class[j] <- "16-20"
}
if (df$duration[j] > 20 & df$duration[j] <= 30) {
df$duration_class[j] <- "21-30"
}
if (df$duration[j] > 30 & df$duration[j] <= 40) {
df$duration_class[j] <- "31-40"
}
if (df$duration[j] > 40 & df$duration[j] <= 50) {
df$duration_class[j] <- "41-50"
}
if (df$duration[j] > 50 & df$duration[j] <= 60) {
df$duration_class[j] <- "51-60"
}
}
dfd <- df %>%
group_by(`Eco-Region`,duration_class) %>%
summarise(n = length(`Survey name`))
dfd <- data.frame(dfd %>% arrange(duration_class))
dfd$duration_class <- as.character(dfd$duration_class)
if (tot_survey > nrow(df)) {
nas <- tot_survey - nrow(df)
rows <- nrow(dfd) + 1
dfd[rows, ] <- NA
dfd$duration_class[rows] <- "NA"
dfd$n[rows] <- nas
}
dfd$duration_class <- as.factor(dfd$duration_class)
dfd$Eco.Region <- unlist(lapply(strwrap(dfd$Eco.Region, width = 30, simplify = FALSE), paste, collapse = "\n"))
dfd <- dfd %>% arrange(Eco.Region)
theme_set(theme_bw())
ggplot(dfd, aes(x = duration_class, y = n)) +
geom_bar(stat = "identity", color = "#1e90ff", fill = "#1e90ff") +
xlab("Time series length (years)") +
ylab("Number of surveys") +
# geom_text(aes(label = n), vjust = 1.5, colour = "white") +
labs(fill = "Number\nof surveys") +
theme(axis.text.x = element_text(angle = 90),
legend.position = "none"
# , panel.grid = element_blank()
)+
facet_wrap(.~Eco.Region)+
theme(text = element_text(size = 15),
axis.text.x = element_text(size = 18),
axis.text.y = element_text(size = 18),
axis.title.x = element_text(size = 18),
axis.title.y = element_text(size = 18))
ggsave(file.path(resdir,'Time_series_length_per_ecoregion.jpg'),height=8,width=10, units='in', dpi=300)
# filtering data
df <- d[, which(colnames(d) %in% c("ICES Eco-Region", "Survey name", "Quarter"))]
colnames(df) <- c("Eco-region", "Survey name", "Quarter")
dx <- data.frame(matrix(ncol = 3, nrow = 0))
colnames(dx) <- c("Eco-region", "Survey name", "Quarter")
i <- 58
for (i in 1:nrow(df)) {
t <- as.character(df[i, "Eco-region"])
t <- strsplit(t, ", ")
t <- t[[1]]
n <- 1
for (n in 1:length(t)) {
l <- nrow(dx) + 1
dx[l, "Eco-region"] <- t[n]
dx[l, "Survey name"] <- df[i, "Survey name"]
dx[l, "Quarter"] <- df[i, "Quarter"]
}
}
df <- dx
df$Quarter <- sub(" ", "", df$Quarter)
df <- df[!is.na(df$Quarter), ]
df <- df[df$Quarter != "variable", ]
for (i in 1:nrow(df)) {
if (is.na(df$`Survey name`[i])) {
df$`Survey name`[i] <- paste("Survey",i)
}
}
df <- df %>%
group_by(`Eco-region`, `Survey name`, Quarter) %>%
summarise()
tx <- data.frame(matrix(ncol = 3, nrow = 0))
colnames(tx) <- c("Eco-region", "survey", "Quarter")
i <- 82
for (i in 1:nrow(df)) {
t <- as.character(df[i, "Quarter"])
t <- strsplit(t, ",")
t <- t[[1]]
survey <- df[i, "Survey name"]
ecoregion <- df[i, "Eco-region"]
n <- 1
for (n in 1:length(t)) {
l <- nrow(tx) + 1
tx[l, "Quarter"] <- as.numeric(t[n])
tx[l, "survey"] <- survey
tx[l, "Eco-region"] <- ecoregion
}
}
tx2 <- tx %>%
group_by(`Eco-region`, survey, Quarter) %>%
summarise()
dq <- tx2 %>%
group_by(`Eco-region`, Quarter) %>%
summarise(n = length(Quarter))
dq$Quarter <- as.factor(dq$Quarter)
dq$`Eco-region` <- unlist(lapply(strwrap(dq$`Eco-region`, width = 30, simplify = FALSE), paste, collapse = "\n"))
theme_set(theme_bw())
ggplot(dq, aes(x = Quarter, y = n)) +
geom_bar(stat = "identity", color = "#ffffff", fill = "#1e90ff") +
xlab("Quarters") +
ylab("Surveys coverage of quarters per Eco-region") +
facet_wrap(. ~ `Eco-region`)+
theme()+
theme(text = element_text(size = 15),
axis.text.x = element_text(size = 18),
axis.text.y = element_text(size = 18),
axis.title.x = element_text(size = 18),
axis.title.y = element_text(size = 18))
ggsave(file.path(resdir,'Surveys_per_quarter_and_ecoregion.jpg'),height=8,width=10, units='in', dpi=300)
#----- depth coverage
df <- data.frame(d[, which(colnames(d) %in% c("ICES Eco-Region", "Depth strata range (m)", "Survey name"))])
colnames(df) <- c("ICES Eco-Region", "Survey name", "Depth strata range (m)")
df <- df[!is.na(df$`Depth strata range (m)`) & df$`Depth strata range (m)` != "NA", ]
depth <- df$`Depth strata range (m)`
lim0 <- grep("< ", depth)
if (length(lim0) > 0) {
depth[lim0] <- gsub("< ", "0-", depth[lim0])
}
d0 <- grep("â", depth)
if (length(d0) > 0) {
depth[d0] <- gsub("â", "-", depth[d0])
}
depth <- gsub("â", "-", depth)
depth <- strsplit(depth, "-")
depth <- do.call(rbind, depth)
depth <- as.data.frame(depth)
colnames(depth) <- c("min", "max")
depth$min <- as.numeric(depth$min)
depth$max <- as.numeric(depth$max)
df$min <- depth$min
df$max <- depth$max
df <- df %>%
group_by(`ICES Eco-Region`, `Survey name`, `Depth strata range (m)`, min, max) %>%
summarise()
df$strata <- NA
i <- 1
for (i in 1:nrow(df)) {
if (df$min[i] <= 200 & df$max[i] <= 200) {
df$strata[i] <- "shelf only"
} else if ((df$min[i] >= 200 & df$max[i] >= 200)) {
df$strata[i] <- "slope only"
} else {
df$strata[i] <- "shelf & slope"
}
}
dx <- data.frame(matrix(ncol = 6, nrow = 0))
colnames(dx) <- c("ICES Eco-Region", "Survey name", "Depth strata range (m)", "min", "max", "strata")
i <- 29
for (i in 1:nrow(df)) {
t <- as.character(df[i, "ICES Eco-Region"])
t <- strsplit(t, ", ")
t <- t[[1]]
n <- 1
survey <- as.character(df[i, "Survey name"])
if (is.na(survey)) {
survey <- as.character(sample(c(1:100), 1))
}
for (n in 1:length(t)) {
l <- nrow(dx) + 1
dx[l, "ICES Eco-Region"] <- t[n]
dx[l, "Survey name"] <- survey
dx[l, "Depth strata range (m)"] <- df[i, "Depth strata range (m)"]
dx[l, "min"] <- df[i, "min"]
dx[l, "max"] <- df[i, "max"]
dx[l, "strata"] <- df[i, "strata"]
}
}
df <- dx %>%
group_by(`ICES Eco-Region`, `Survey name`, `Depth strata range (m)`, min, max, strata) %>%
summarise()
pie <- df %>%
group_by(`ICES Eco-Region`, strata) %>%
summarise(n = length(strata))
# pie chart
n <- nrow(pie)
myPalette <- rainbow(n)
eco <- eco_temp
ecos <- unique(df$`ICES Eco-Region`)
eco <- eco[eco$Ecoregion %in% ecos, ]
centroids <- centroids(eco, inside = TRUE)
centroids <- data.frame(Ecoregion = eco$Ecoregion, geom(centroids))
library(reshape2)
tx <- dcast(pie, `ICES Eco-Region` ~ strata, value.var = )
tx[is.na(tx)] <- 0
tx2 <- merge(centroids[, c(which(colnames(centroids) %in% c("Ecoregion", "x", "y")))],
tx,
by.x = "Ecoregion", by.y = "ICES Eco-Region"
)
colnames(tx2) <- c("Ecoregion", "Lon", "Lat", "shelf & slope", "shelf only", "slope only")
library(scatterpie)
tx2$Ecoregion <- as.factor(tx2$Ecoregion)
tx2$radius <- rowSums(tx2[, c(4:6)]) * 10000
world <- map_data("world")
w <- data.frame(long = world$long, lat = world$lat)
coordinates(w) <- ~ long + lat
crs(w) <- crs("EPSG:4326")
w <- spTransform(w, crs("EPSG:3035"))
w <- as.data.frame(w)
world$long <- w$long
world$lat <- w$lat
e <- ext(eco)
xl <- c(e[1], e[2])
yl <- c(e[3], e[4])
e2 <- ext(fao_4326)
xl2 <- c(e2[1], e2[2])
yl2 <- c(e2[3], e2[4])
x_breaks <- c(round(xl2[1], 0), round(xl2[1], 0) + round((xl2[2] - xl2[1]) / 2, 0), round(xl2[1], 0) + 2 * round((xl2[2] - xl2[1]) / 2, 0))
y_breaks <- c(round(yl2[1], 0), round(yl2[1], 0) + round((yl2[2] - yl2[1]) / 2, 0), round(yl2[1], 0) + 2 * round((yl2[2] - yl2[1]) / 2, 0))
ggplot() +
geom_spatvector(data = eco) +
geom_polygon(data = world, aes(x = long, y = lat, group = group), fill = "lightgrey", color = "#282828",size=0.2) +
geom_scatterpie(aes(x = Lon, y = Lat, group = Ecoregion), cols = c("shelf only", "shelf & slope", "slope only"), data = tx2, pie_scale = 3.2) +
coord_sf(xlim = c(-208764, 6683391), ylim = c(861188, 6969164.9), expand = TRUE) +
labs(fill = "Depth strata") +
ggtitle("Proportion of depth coverage") +
xlab("Longitude") +
ylab("Latitude")+
theme(text = element_text(size = 20))
ggsave(file.path(resdir,'Depth_strata_coverage.jpg'),height=8,width=10, units='in', dpi=300)
df <- d[, which(colnames(d) %in% c("Survey name", "Average number of hauls per year"))]
colnames(df) <- c("Survey name", "hauls")
ll <- nrow(df[is.na(df$`Survey name`), ])
ddd <- which(is.na(df$`Survey name`))
if (ll>0){
for (i in 1:ll) {
df[ddd[i], "Survey name"] <- paste("Survey", i)
}
}
tot_survey <- length(unique(df$`Survey name`))
df <- df[!is.na(df$hauls) & df$hauls != "NA", ]
df <- df %>%
group_by(`Survey name`, hauls) %>%
summarise()
df$hauls <- as.numeric(df$hauls)
df <- df %>%
group_by(`Survey name`) %>%
summarise(hauls = sum(hauls))
nas <- nrow(df)
for (j in 1:nrow(df)) {
if (df$hauls[j] > 5 & df$hauls[j] <= 20) {
df$hauls_class[j] <- "5-20"
}
if (df$hauls[j] > 20 & df$hauls[j] <= 50) {
df$hauls_class[j] <- "21-50"
}
if (df$hauls[j] > 50 & df$hauls[j] <= 100) {
df$hauls_class[j] <- "51-100"
}
if (df$hauls[j] > 100 & df$hauls[j] <= 200) {
df$hauls_class[j] <- "101-200"
}
if (df$hauls[j] > 200 & df$hauls[j] <= 300) {
df$hauls_class[j] <- "201-300"
}
if (df$hauls[j] > 300 & df$hauls[j] <= 500) {
df$hauls_class[j] <- "301-500"
}
if (df$hauls[j] > 500) {
df$hauls_class[j] <- ">500"
}
}
dfd <- df %>%
group_by(hauls_class) %>%
summarise(n = length(`Survey name`))
dfd <- data.frame(dfd %>% arrange(hauls_class))
dfd$hauls_class <- as.character(dfd$hauls_class)
if (tot_survey > nrow(df)) {
nas <- tot_survey - nrow(df)
rows <- nrow(dfd) + 1
dfd[rows, ] <- NA
dfd$hauls_class[rows] <- "NA"
dfd$n[rows] <- nas
}
dfd <- dfd %>% arrange(hauls_class)
dfd$hauls_class <- as.factor(dfd$hauls_class)
dfd$hauls_class <- factor(dfd$hauls_class, levels = c("5-20", "21-50", "51-100", "101-200", "201-300", "301-500", ">500", "NA"))
theme_set(theme_bw())
ggplot(dfd, aes(x = hauls_class, y = n)) +
geom_bar(stat = "identity", color = "#1e90ff", fill = "#1e90ff") +
xlab("Number of hauls") +
ylab("Number of surveys") +
geom_text(aes(label = n), vjust = 1.5, colour = "white",size=5) +
theme(legend.position = "none")+
theme(text = element_text(size = 20),
axis.text.x = element_text(angle = 45, hjust = 1))
ggsave(file.path(resdir,'Number_of_hauls.jpg'),height=5,width=8, units='in', dpi=300)
df <- data.frame(d[, which(colnames(d) %in% c("ICES Eco-Region", "Survey name", "Average number of hauls per year"))])
colnames(df) <- c("Eco-region", "Survey name", "hauls")
dx <- data.frame(matrix(ncol = 3, nrow = 0))
colnames(dx) <- c("Eco-region", "Survey name", "hauls")
i <- 58
for (i in 1:nrow(df)) {
t <- as.character(df[i, "Eco-region"])
t <- strsplit(t, ", ")
t <- t[[1]]
n <- 1
for (n in 1:length(t)) {
l <- nrow(dx) + 1
dx[l, "Eco-region"] <- t[n]
dx[l, "Survey name"] <- df[i, "Survey name"]
dx[l, "hauls"] <- df[i, "hauls"]
}
}
df <- dx
df$hauls <- as.numeric(df$hauls)
df <- df %>%
group_by(`Eco-region`, `Survey name`, hauls) %>%
summarise()
df$hauls_class <- NA
for (j in 1:nrow(df)) {
if (df$hauls[j] > 5 & df$hauls[j] <= 20 & !is.na(df$hauls[j])) {
df$hauls_class[j] <- "5-20"
}
if (df$hauls[j] > 20 & df$hauls[j] <= 50 & !is.na(df$hauls[j])) {
df$hauls_class[j] <- "21-50"
}
if (df$hauls[j] > 50 & df$hauls[j] <= 100 & !is.na(df$hauls[j])) {
df$hauls_class[j] <- "51-100"
}
if (df$hauls[j] > 100 & df$hauls[j] <= 200 & !is.na(df$hauls[j])) {
df$hauls_class[j] <- "101-200"
}
if (df$hauls[j] > 200 & df$hauls[j] <= 300 & !is.na(df$hauls[j])) {
df$hauls_class[j] <- "201-300"
}
if (df$hauls[j] > 300 & df$hauls[j] <= 500 & !is.na(df$hauls[j])) {
df$hauls_class[j] <- "301-500"
}
if (df$hauls[j] > 500 & !is.na(df$hauls[j]) ) {
df$hauls_class[j] <- ">500"
}
if (is.na(df$hauls[j])) {
df$hauls_class[j] <- "NA"
}
}
dfd2 <- df %>%
group_by(`Eco-region`, hauls_class) %>%
summarise(n = length(`Survey name`))
dfd2 <- dfd2 %>% arrange(hauls_class)
dfd2$hauls_class <- as.factor(dfd2$hauls_class)
dfd2$hauls_class <- factor(dfd2$hauls_class, levels = c("5-20", "21-50", "51-100", "101-200", "201-300", "301-500", ">500", "NA"))
dfd2$`Eco-region` <- unlist(lapply(strwrap(dfd2$`Eco-region`, width = 30, simplify = FALSE), paste, collapse = "\n"))
theme_set(theme_bw())
ggplot(dfd2, aes(x = hauls_class, y = n)) +
geom_bar(stat = "identity", color = "#ffffff", fill = "#1e90ff") +
xlab("Number of hauls") +
ylab("Surveys per hauls number and Eco-region") +
theme(legend.position = "none") +
facet_wrap(. ~ `Eco-region`) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
theme() +
theme(text = element_text(size = 15),
axis.text.x = element_text(size = 16),
axis.text.y = element_text(size = 16),
axis.title.x = element_text(size = 18),
axis.title.y = element_text(size = 18))
ggsave(file.path(resdir,'Number_of_hauls_per_ecoregion.jpg'),height=8,width=10, units='in', dpi=300)
rm(list=ls())
library(plyr)
library(tidyverse)
# library(MEDITS)
library(sf)
library(reshape2)
library(ape)
library(rstatix)
setwd("D:\\HMSC\\DATA\\MEDITS_data")
setwd("D:\\COISPA\\B-USEFUL\\_MEDITS_Corrected_data_")
# # MERGE TA FILES FROM ALL GSAs
ta.files <- list.files(pattern="TA.*?\\.csv") # list all csv files that start with "TA"
ta.files
ta_list <- lapply(ta.files, function(x) {read.csv(x, sep = ";", dec='.', header = T)}) # read them all at once into a list
ta <- ldply(ta_list, data.frame) # merge into single dataframe
ta<-ta[ta$VALIDITY=='V',] # only keep valid hauls
ta <- ta[ta$AREA %in% c(9,10,11,16,17,18,19)]
ta <- ta[ta$AREA %in% c(9,10,11,16,17,18,19),]
ta
ta2 <- BioIndex::MEDITS.to.dd(ta)
ta2
ta2 <- ta2[ta2$COUNTRY %in% c("ITA"), ]
plot(ta2$SHOOTING_LONGITUDE,ta2$SHOOTING_LATITUDE)
write.table(ta,"D:\\OneDrive - Coispa Tecnologia & Ricerca S.C.A.R.L\\- Appoggio -\\MTS\\Mappa_MEDITS_ITA\\TA_ITA_1999_2021.csv",sep=";",row.names = FALSE)
write.table(ta2,"D:\\OneDrive - Coispa Tecnologia & Ricerca S.C.A.R.L\\- Appoggio -\\MTS\\Mappa_MEDITS_ITA\\TA_ITA_1999_2021.csv",sep=";",row.names = FALSE)
rm(list=ls())
library(plyr)
library(tidyverse)
# library(MEDITS)
library(sf)
library(reshape2)
library(ape)
library(rstatix)
# VIF function from ZuurÂ´s paper
source('D:\\HMSC\\scripts/vif.R')
setwd("D:\\COISPA\\B-USEFUL\\_MEDITS_Corrected_data_")
text <- "ALL_GSAs"
# MERGE MEDITS FILES
#---------------------------------------------------------
# # MERGE TA FILES FROM ALL GSAs
ta.files <- list.files(pattern="TA.*?\\.csv") # list all csv files that start with "TA"
ta_list <- lapply(ta.files, function(x) {read.csv(x, sep = ";", dec='.', header = T)}) # read them all at once into a list
ta <- ldply(ta_list, data.frame) # merge into single dataframe
ta<-ta[ta$VALIDITY=='V',] # only keep valid hauls
ta <- ta[ta$AREA %in% c(9,10,11,16,17,18,19),]
ta2 <- BioIndex::MEDITS.to.dd(ta)
ta2[ta2$AREA %in% c(18), "COUNTRY"]
unique(ta2[ta2$AREA %in% c(18), "COUNTRY"])
ta2[ta2$AREA %in% c(18), "COUNTRY"] <- "ITA"
ta2 <- ta2[ta2$COUNTRY %in% c("ITA"), ]
plot(ta2$SHOOTING_LONGITUDE,ta2$SHOOTING_LATITUDE)
write.table(ta2,"D:\\OneDrive - Coispa Tecnologia & Ricerca S.C.A.R.L\\- Appoggio -\\MTS\\Mappa_MEDITS_ITA\\TA_ITA_1999_2021.csv",sep=";",row.names = FALSE)
